<!DOCTYPE html>
<html lang="nl" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>STM Group â€” RFQ Configurator</title>
<link rel="icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES & RESET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --o: #F94816; --dk: #22293B; --dk2: #314056; --lt: #F6F7F9; --wh: #FFFFFF;
  --gr: #2ECC71; --grL: #E8F8F0; --bl: #4A90D9; --blL: #EBF3FC;
  --bor: #E2E5EA; --txt: #333; --txtL: #777; --red: #E74C3C;
  --col-left: 290px; --col-right: 340px;
  --hdr: 52px; --tab: 42px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--lt);color:var(--txt);font-size:13px;overflow:hidden;height:100vh;}
input,select,textarea,button{font-family:inherit;font-size:13px;}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:#aaa;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar{height:var(--hdr);background:var(--dk);display:flex;align-items:center;padding:0 16px;gap:12px;z-index:100;}
.topbar .logo{color:var(--o);font-weight:700;font-size:16px;letter-spacing:.5px;white-space:nowrap;}
.topbar .logo span{color:#fff;font-weight:400;margin-left:4px;font-size:12px;opacity:.7;}
.topbar .spacer{flex:1;}
.lang-bar{display:flex;gap:2px;}
.lang-bar button{background:transparent;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.6);padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;transition:.15s;}
.lang-bar button:hover{border-color:rgba(255,255,255,.3);color:#fff;}
.lang-bar button.on{background:var(--o);border-color:var(--o);color:#fff;}
.topbar .btn-export{background:var(--o);color:#fff;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;font-weight:600;font-size:12px;transition:.15s;}
.topbar .btn-export:hover{background:#e03d0e;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabbar{height:var(--tab);background:var(--dk2);display:flex;align-items:stretch;padding:0 16px;gap:2px;}
.tabbar button{background:transparent;border:none;color:rgba(255,255,255,.5);padding:0 18px;cursor:pointer;font-size:12px;font-weight:500;border-bottom:2px solid transparent;transition:.15s;}
.tabbar button:hover{color:rgba(255,255,255,.8);}
.tabbar button.on{color:#fff;border-bottom-color:var(--o);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app{display:flex;height:calc(100vh - var(--hdr) - var(--tab));overflow:hidden;}
.col-left{width:var(--col-left);min-width:260px;max-width:460px;background:var(--wh);border-right:1px solid var(--bor);display:flex;flex-direction:column;overflow:hidden;}
.col-mid{flex:1;min-width:300px;overflow:hidden;display:flex;flex-direction:column;}
.col-right{width:var(--col-right);min-width:260px;max-width:520px;background:var(--wh);border-left:1px solid var(--bor);display:flex;flex-direction:column;overflow:hidden;}
.drag-h{width:5px;cursor:col-resize;background:transparent;transition:background .15s;flex-shrink:0;}
.drag-h:hover,.drag-h.dragging{background:var(--o);}

/* scrollable areas */
.scroll{flex:1;overflow-y:auto;padding:12px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECT & SUPPLIER SELECTORS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.selector{margin-bottom:12px;}
.selector label{display:block;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--dk2);margin-bottom:4px;}
.search-box{position:relative;}
.search-box input{width:100%;padding:7px 10px 7px 30px;border:1px solid var(--bor);border-radius:5px;font-size:12px;outline:none;transition:.15s;}
.search-box input:focus{border-color:var(--o);box-shadow:0 0 0 2px rgba(249,72,22,.12);}
.search-box .icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--txtL);pointer-events:none;}
.dropdown{position:absolute;top:100%;left:0;right:0;max-height:220px;overflow-y:auto;background:var(--wh);border:1px solid var(--bor);border-radius:0 0 6px 6px;box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:50;display:none;}
.dropdown.show{display:block;}
.dropdown .dd-item{padding:6px 10px;cursor:pointer;font-size:12px;border-bottom:1px solid #f0f0f0;transition:.08s;}
.dropdown .dd-item:hover{background:var(--lt);}
.dropdown .dd-item .main{font-weight:500;color:var(--dk);}
.dropdown .dd-item .sub{font-size:10px;color:var(--txtL);margin-top:1px;}
.dropdown .dd-cat{padding:4px 10px;font-size:10px;font-weight:700;color:var(--o);text-transform:uppercase;background:#fafafa;border-bottom:1px solid #eee;}
.selected-tag{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--grL);border:1px solid var(--gr);border-radius:5px;margin-top:4px;font-size:11px;}
.selected-tag .name{font-weight:500;flex:1;}
.selected-tag .clear{cursor:pointer;color:var(--red);font-size:14px;line-height:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAPTER & BLOCK LIST (left sidebar)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ch-group{margin-bottom:6px;}
.ch-head{display:flex;align-items:center;padding:8px 10px;background:#f8f8fa;border-radius:6px;cursor:pointer;user-select:none;transition:.1s;gap:6px;}
.ch-head:hover{background:#f0f1f3;}
.ch-head .arrow{font-size:10px;color:var(--txtL);transition:transform .15s;width:14px;text-align:center;}
.ch-head.open .arrow{transform:rotate(90deg);}
.ch-head .num{background:var(--o);color:#fff;font-size:10px;font-weight:700;border-radius:3px;padding:1px 5px;min-width:20px;text-align:center;}
.ch-head .title{flex:1;font-weight:500;font-size:12px;}
.ch-head .count{font-size:10px;color:var(--txtL);}
.ch-blocks{display:none;padding:3px 0 3px 14px;}
.ch-group.open .ch-blocks{display:block;}
.bl-item{display:flex;align-items:center;padding:5px 8px;border-radius:4px;cursor:pointer;gap:6px;transition:.08s;margin:1px 0;}
.bl-item:hover{background:var(--lt);}
.bl-item.active{background:var(--blL);}
.bl-item .chk{width:16px;height:16px;border:2px solid var(--bor);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px;color:transparent;transition:.1s;flex-shrink:0;}
.bl-item.on .chk{background:var(--o);border-color:var(--o);color:#fff;}
.bl-item .bl-label{flex:1;font-size:11.5px;line-height:1.3;}
.bl-item .bl-tag{font-size:9px;padding:1px 4px;border-radius:2px;background:#eee;color:var(--txtL);}
.bl-item.delegated .bl-label{color:var(--bl);font-style:italic;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLE FORM (middle panel)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mid-header{padding:12px 16px;border-bottom:1px solid var(--bor);background:var(--wh);}
.mid-header h3{font-size:14px;font-weight:600;color:var(--dk);}
.mid-header p{font-size:11px;color:var(--txtL);margin-top:2px;}
.block-card{background:var(--wh);border:1px solid var(--bor);border-radius:8px;margin:8px;padding:14px;transition:.15s;}
.block-card:hover{border-color:#ccd;}
.block-card h4{font-size:13px;font-weight:600;color:var(--dk);margin-bottom:4px;}
.block-card .block-desc{font-size:11px;color:var(--txtL);margin-bottom:10px;}
.block-controls{display:flex;gap:6px;margin-bottom:10px;}
.toggle-btn{padding:4px 10px;border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--bor);background:var(--wh);transition:.1s;}
.toggle-btn:hover{border-color:#aaa;}
.toggle-btn.on{background:var(--bl);border-color:var(--bl);color:#fff;}
.toggle-btn.del.on{background:var(--bl);border-color:var(--bl);color:#fff;}

.var-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;}
.var-field label{display:block;font-size:10px;font-weight:600;color:var(--dk2);margin-bottom:3px;text-transform:uppercase;letter-spacing:.3px;}
.var-field input,.var-field select,.var-field textarea{width:100%;padding:6px 8px;border:1px solid var(--bor);border-radius:4px;outline:none;transition:.15s;font-size:12px;}
.var-field input:focus,.var-field select:focus,.var-field textarea:focus{border-color:var(--o);box-shadow:0 0 0 2px rgba(249,72,22,.1);}
.var-field textarea{min-height:60px;resize:vertical;}
.var-field .unit{font-size:10px;color:var(--txtL);margin-top:1px;}
.var-field.auto-filled input,.var-field.auto-filled select{border-color:var(--gr);background:var(--grL);}
.var-field.supplier-spec input,.var-field.supplier-spec select{border-color:var(--bl);background:var(--blL);font-style:italic;}
.var-field .sup-toggle{font-size:9px;color:var(--bl);cursor:pointer;margin-top:2px;display:inline-block;}
.var-field .sup-toggle:hover{text-decoration:underline;}

.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--txtL);gap:8px;}
.empty-state .icon{font-size:40px;opacity:.3;}
.empty-state p{font-size:12px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIEW (right panel)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.preview-header{padding:10px 14px;border-bottom:1px solid var(--bor);background:var(--wh);display:flex;justify-content:space-between;align-items:center;}
.preview-header h3{font-size:13px;font-weight:600;color:var(--dk);}
.preview-body{padding:16px;font-size:11.5px;line-height:1.7;color:var(--dk);}
.preview-body .pv-chapter{font-size:14px;font-weight:700;color:var(--o);margin:18px 0 6px;padding-bottom:4px;border-bottom:1.5px solid var(--o);}
.preview-body .pv-chapter:first-child{margin-top:0;}
.preview-body .pv-block-title{font-weight:600;color:var(--dk);margin:10px 0 3px;font-size:12px;}
.preview-body .pv-line{margin:2px 0;}
.preview-body .pv-bullet{margin:1px 0 1px 16px;}
.preview-body .pv-var{background:#FFF3EE;color:var(--o);padding:0 3px;border-radius:2px;font-weight:500;}
.preview-body .pv-var.filled{background:var(--grL);color:#1a8a4a;}
.preview-body .pv-var.supplier{background:var(--blL);color:var(--bl);font-style:italic;}
.preview-body .pv-delegated{color:var(--bl);font-style:italic;padding:4px 8px;background:var(--blL);border-radius:4px;margin:4px 0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.statusbar{height:28px;background:var(--dk);display:flex;align-items:center;padding:0 14px;gap:16px;font-size:11px;color:rgba(255,255,255,.5);}
.statusbar .st-item{display:flex;align-items:center;gap:4px;}
.statusbar .st-dot{width:7px;height:7px;border-radius:50%;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB CONTENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tab-content{display:none;height:calc(100vh - var(--hdr) - var(--tab) - 28px);}
.tab-content.active{display:flex;flex-direction:column;}
.editor-placeholder{display:flex;align-items:center;justify-content:center;height:100%;background:var(--lt);color:var(--txtL);flex-direction:column;gap:12px;}
.editor-placeholder .icon{font-size:48px;opacity:.25;}
.editor-placeholder p{font-size:14px;}
.editor-placeholder small{font-size:11px;opacity:.6;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RTL SUPPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[dir="rtl"] .col-left{border-right:none;border-left:1px solid var(--bor);}
[dir="rtl"] .col-right{border-left:none;border-right:1px solid var(--bor);}
[dir="rtl"] .ch-blocks{padding-left:0;padding-right:14px;}
[dir="rtl"] .search-box input{padding-left:10px;padding-right:30px;}
[dir="rtl"] .search-box .icon{left:auto;right:9px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading-overlay{position:fixed;inset:0;background:var(--dk);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:16px;}
.loading-overlay .spinner{width:36px;height:36px;border:3px solid rgba(255,255,255,.15);border-top-color:var(--o);border-radius:50%;animation:spin .7s linear infinite;}
.loading-overlay p{color:rgba(255,255,255,.6);font-size:13px;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <p>Loading STM RFQ Configurator...</p>
</div>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">STM<span>GROUP</span></div>
  <div class="spacer"></div>
  <div class="lang-bar" id="lang-bar"></div>
  <button class="btn-export" id="btn-export" onclick="exportToWord()">â¬‡ Word Export</button>
</div>

<!-- TABS -->
<div class="tabbar">
  <button class="on" onclick="switchTab('config',this)">ğŸ“‹ Configurator</button>
  <button onclick="switchTab('editor',this)">âœï¸ Block Editor</button>
</div>

<!-- TAB 1: CONFIGURATOR -->
<div class="tab-content active" id="tab-config">
  <div class="app">
    <!-- LEFT SIDEBAR -->
    <div class="col-left" id="col-left">
      <div class="scroll" id="left-scroll">
        <!-- Project Selector -->
        <div class="selector" id="proj-selector">
          <label id="lbl-proj">ğŸ” Project selecteren</label>
          <div class="search-box">
            <span class="icon">âŒ•</span>
            <input type="text" id="proj-search" placeholder="Zoek op naam of nummer..." oninput="filterProjects()" onfocus="showDropdown('proj')" autocomplete="off">
            <div class="dropdown" id="proj-dd"></div>
          </div>
          <div id="proj-selected" style="display:none"></div>
        </div>

        <!-- Supplier Selector -->
        <div class="selector" id="supp-selector">
          <label id="lbl-supp">ğŸ¢ Leverancier selecteren</label>
          <div class="search-box">
            <span class="icon">âŒ•</span>
            <input type="text" id="supp-search" placeholder="Zoek leverancier..." oninput="filterSuppliers()" onfocus="showDropdown('supp')" autocomplete="off">
            <div class="dropdown" id="supp-dd"></div>
          </div>
          <div id="supp-selected" style="display:none"></div>
        </div>

        <!-- RFQ metadata -->
        <div style="padding:0 0 8px;border-bottom:1px solid var(--bor);margin-bottom:8px;">
          <div style="display:flex;gap:6px;margin-bottom:6px;">
            <div style="flex:1"><label style="font-size:10px;font-weight:600;color:var(--dk2);text-transform:uppercase;display:block;margin-bottom:2px;">RFQ Nr.</label><input type="text" id="rfq-num" style="width:100%;padding:5px 7px;border:1px solid var(--bor);border-radius:4px;font-size:11px;" placeholder="RFQ-2025-0001"></div>
            <div style="flex:1"><label style="font-size:10px;font-weight:600;color:var(--dk2);text-transform:uppercase;display:block;margin-bottom:2px;">Datum</label><input type="date" id="rfq-date" style="width:100%;padding:5px 7px;border:1px solid var(--bor);border-radius:4px;font-size:11px;"></div>
          </div>
          <div><label style="font-size:10px;font-weight:600;color:var(--dk2);text-transform:uppercase;display:block;margin-bottom:2px;" id="lbl-scope">Scope omschrijving</label><input type="text" id="scope-desc" style="width:100%;padding:5px 7px;border:1px solid var(--bor);border-radius:4px;font-size:11px;" placeholder="bijv. montage dak- en gevelbeplating" oninput="onScopeChange()"></div>
        </div>

        <!-- Chapter/Block tree -->
        <div style="margin-bottom:4px;display:flex;align-items:center;justify-content:space-between;">
          <span style="font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--dk2);" id="lbl-chapters">Hoofdstukken</span>
          <button onclick="resetAll()" style="font-size:10px;border:none;background:none;color:var(--o);cursor:pointer;font-weight:500;">â†» Reset</button>
        </div>
        <div id="ch-list"></div>
      </div>
    </div>

    <!-- DRAG LEFT -->
    <div class="drag-h" id="drag-left"></div>

    <!-- MIDDLE: VARIABLES -->
    <div class="col-mid" id="col-mid">
      <div class="mid-header" id="mid-header">
        <h3 id="mid-title">Selecteer een tekstblok</h3>
        <p id="mid-desc">Klik op een blok in het linker paneel om de variabelen te bewerken.</p>
      </div>
      <div class="scroll" id="mid-scroll">
        <div class="empty-state" id="mid-empty">
          <div class="icon">ğŸ“</div>
          <p>Selecteer een blok om variabelen te bewerken</p>
        </div>
        <div id="var-container" style="display:none;"></div>
      </div>
    </div>

    <!-- DRAG RIGHT -->
    <div class="drag-h" id="drag-right"></div>

    <!-- RIGHT: PREVIEW -->
    <div class="col-right" id="col-right">
      <div class="preview-header">
        <h3 id="pv-title">ğŸ“„ Preview</h3>
      </div>
      <div class="scroll">
        <div class="preview-body" id="preview"></div>
      </div>
    </div>
  </div>
</div>

<!-- TAB 2: EDITOR (placeholder for step 2) -->
<div class="tab-content" id="tab-editor">
  <div class="editor-placeholder">
    <div class="icon">âœï¸</div>
    <p>Block Editor â€” Coming in Phase 2</p>
    <small>Content management for non-technical colleagues</small>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <div class="st-item"><span class="st-dot" style="background:var(--o)"></span> <span id="st-blocks">0 blokken</span></div>
  <div class="st-item"><span class="st-dot" style="background:var(--gr)"></span> <span id="st-vars">0/0 variabelen</span></div>
  <div class="st-item"><span class="st-dot" style="background:var(--bl)"></span> <span id="st-del">0 delegated</span></div>
</div>

<!-- LIBS -->
<script src="lib/jszip.min.js"></script>
<script src="lib/FileSaver.min.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMBEDDED DATA: Projects (24KB) & Business Types (1KB)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROJECTS=[{"nr": "STPR25004", "name": "BV Neubau Lagerhalle, Feldstr 22-24, Oberhausen", "addr": "Feldstr. 22-44", "zip": "49149", "city": "Oberhausen", "exc": 0, "tol": 0, "start": "2025-07-21", "end": "", "client": "Petra Bortz-Ittner", "clientCity": "Oberhausen"}, {"nr": "STP23006", "name": "Solar Carports Clinical Trial Services", "addr": "Gronausestraat 98", "zip": "7581 CJ", "city": "Losser", "exc": 0, "tol": 0, "start": "2023-01-16", "end": "2024-02-02", "client": "Clinical trial services BV", "clientCity": "Losser"}, {"nr": "STP19002", "name": "Fortior Fase 2; Nieuwbouw Bedrijfsverzamelgebouw", "addr": "De Reulver 30", "zip": "7544RT", "city": "Enschede", "exc": 0, "tol": 0, "start": "2019-02-04", "end": "", "client": "Fortior Real Estate BV", "clientCity": "Enschede"}, {"nr": "STPR23004", "name": "BV Ludwig Zenger, Kerpen, Neubau einer Lagerhalle", "addr": "Karl-Ferdinand-Braun-StraÃŸe", "zip": "50170", "city": "Kerpen-Sindorf", "exc": 0, "tol": 0, "start": "2023-06-30", "end": "2024-12-20", "client": "Ludwig Zenger Industrie-Service GmbH", "clientCity": "Kerpen (TÃ¼rnich)"}, {"nr": "STPR24005", "name": "BV Buro mit Halle and Produktion Koln", "addr": "Picolloministrasse 23", "zip": "", "city": "Koln", "exc": 0, "tol": 0, "start": "2024-07-22", "end": "", "client": "Kar GmbH", "clientCity": "Koln"}, {"nr": "STP24002", "name": "Nieuwbouw BVG, Reulver, Enschede", "addr": "De Reulver 73", "zip": "7544RT", "city": "Enschede", "exc": 0, "tol": 0, "start": "2024-03-05", "end": "2026-02-27", "client": "Fortior Real Estate BV", "clientCity": "Enschede"}, {"nr": "STP25001", "name": "Nieuwbouw Padel Court, Cuijk", "addr": "Sint Annastraat 1", "zip": "5431BE", "city": "Cuijk", "exc": 0, "tol": 0, "start": "2025-02-06", "end": "", "client": "DuelPadel B.V.", "clientCity": "Almelo"}, {"nr": "STP23004", "name": "Woodstock Phase I;  Stigterstaal Canada inc.", "addr": "38 Garnet Road", "zip": "N3T 5M1", "city": "Brantford, ON", "exc": 0, "tol": 0, "start": "2023-02-02", "end": "2025-07-31", "client": "Stigterstaal B.V.", "clientCity": "GORINCHEM"}, {"nr": "STPR19010", "name": "BV Selha; Lager Halle 5200m2, Koln, DE", "addr": "Bunsenstrasse 6-2", "zip": "D-41540", "city": "Dormagen", "exc": 0, "tol": 0, "start": "2021-11-16", "end": "", "client": "HM Immobilien- & VermÃ¶gensgesellschaft mbH", "clientCity": "Hagen"}, {"nr": "STPR19020", "name": "BV Demka, Lagerhalle + Buro 7450 m2, Mannheim", "addr": "Lembacherstrasse", "zip": "", "city": "Mannheim", "exc": 0, "tol": 0, "start": "2019-09-30", "end": "", "client": "Arzu + Esme Demirdas GbR", "clientCity": "Mannheim"}, {"nr": "STP25012", "name": "Environmental permit & Fireproof Safes Twimva", "addr": "Jaargetijdenweg 33,", "zip": "7532 SX", "city": "Enschede", "exc": 0, "tol": 0, "start": "2025-10-02", "end": "", "client": "Automotive & Refinish BV", "clientCity": "Enschede"}, {"nr": "STPR21002", "name": "BV Fruechte Boquoi, Hagen, DE", "addr": "Neustrasse 15", "zip": "58135", "city": "Hagen", "exc": 0, "tol": 0, "start": "2022-04-04", "end": "2023-12-05", "client": "Birgit Kerenciler", "clientCity": "Gevelsberg"}, {"nr": "STPR23006", "name": "BV Halle AuÃŸen Lager 2, Duisburg", "addr": "Rheindeichstrasse 155", "zip": "47199", "city": "Duisburg", "exc": 0, "tol": 0, "start": "2024-01-15", "end": "2024-04-19", "client": "Bt building technologies GmbH", "clientCity": "KÃ¶ln"}, {"nr": "STP25003", "name": "Nieuwbouw Wesealit, Josink-Es, Enschede", "addr": "Josin kolkweg 10", "zip": "7545PJ", "city": "Enschede", "exc": 0, "tol": 0, "start": "2025-03-12", "end": "", "client": "Weasealit BV", "clientCity": "Enschede"}, {"nr": "STPR24001", "name": "BV Neubau Buro mit Halle, FLIX die fahrschuhle", "addr": "Piccoloministrasse", "zip": "51063", "city": "Koln", "exc": 0, "tol": 0, "start": "2024-01-19", "end": "", "client": "FLIX die Fahrschule", "clientCity": "Koln"}, {"nr": "STPR24006", "name": "BV FreshPark, Dormagen", "addr": "Kruppstrasse 84", "zip": "41540", "city": "Dormagen", "exc": 0, "tol": 0, "start": "2024-09-13", "end": "", "client": "Edeholz GmbH", "clientCity": "Hagen"}, {"nr": "STPR21008", "name": "BV Alfafood Verkaufshalle und Lager sowie Fitnessstudio", "addr": "SchwabenstraÃŸe 38,", "zip": "93053", "city": "Regensburg", "exc": 0, "tol": 0, "start": "2021-05-14", "end": "", "client": "Alfafood GmbH", "clientCity": "NÃ¼rnberg"}, {"nr": "STPR21010", "name": "BV Coil Lager mit Buro", "addr": "Schwerter Strasse 19", "zip": "58099", "city": "Hagen", "exc": 0, "tol": 0, "start": "2021-08-30", "end": "", "client": "Fritz Neuhaus GmbH", "clientCity": "Hagen"}, {"nr": "STPR23005", "name": "BV Renovierung Denkmalschutz Gebaude, Gronau", "addr": "Fabriekstrasse 11", "zip": "", "city": "Gronau", "exc": 0, "tol": 0, "start": "2023-07-28", "end": "", "client": "Nergiz GmbH & Co. KG", "clientCity": "Gronau"}, {"nr": "STP23014", "name": "Nieuwbouw Flex-housing, Ontwikkeling Almelo 3x36st", "addr": "Aaddijk 18", "zip": "7610AA", "city": "Almelo", "exc": 0, "tol": 0, "start": "2023-09-28", "end": "", "client": "Kinada Vastgoed BV", "clientCity": "Almelo"}, {"nr": "STP24003", "name": "Reclamaties 2024", "addr": "Marssteden 52", "zip": "7447TC", "city": "Enschede", "exc": 0, "tol": 0, "start": "2024-03-20", "end": "", "client": "PATboard B.V.", "clientCity": "Enschede"}, {"nr": "STP24001", "name": "Nieuwbouw Mondial Pack BV, Marssteden, Enschede", "addr": "Marssteden 36", "zip": "7547TC", "city": "Enschede", "exc": 0, "tol": 0, "start": "2024-01-12", "end": "", "client": "De Bleekhoek BV", "clientCity": "Enschede"}, {"nr": "STPR23007", "name": "Vertikal-transport ausbau und Laderampe", "addr": "PiccoloministraÃŸe 22", "zip": "51063", "city": "KÃ¶ln", "exc": 0, "tol": 0, "start": "2023-11-17", "end": "", "client": "Maho GmbH", "clientCity": "Koln"}, {"nr": "STP21011", "name": "Nieuwbouw Floret, Logistiek centrum met kantoor, Heinenoord", "addr": "Zaaiviool/Sikkel", "zip": "", "city": "Heienoord", "exc": 0, "tol": 0, "start": "2021-06-14", "end": "2023-04-28", "client": "Floret Holding B.V.", "clientCity": "Rotterdam"}, {"nr": "STPR19014", "name": "BV Ninos, Neubau Lagerhalle + Buro 1.483m2, Borgwardstrasse", "addr": "Einstein-Ring", "zip": "48599", "city": "Gronau", "exc": 0, "tol": 0, "start": "2019-07-24", "end": "", "client": "Ninos Shamon", "clientCity": "Gronau"}, {"nr": "STP22017", "name": "Venlo Containerterminal Solarconstruction", "addr": "Venlo", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2022-11-29", "end": "", "client": "CMS Energiesystemen B.V.", "clientCity": "Horst"}, {"nr": "ST23019", "name": "Boiler and Furnace Platform", "addr": "Romania", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2023-06-09", "end": "", "client": "Host Thermal Technology BV", "clientCity": "Enschede"}, {"nr": "ST22042", "name": "De Sport Fabrik BV Uitbreiding + dak sportrek", "addr": "Smitsbreeweg 8,", "zip": "7581 HE", "city": "Losser", "exc": 0, "tol": 0, "start": "2022-10-12", "end": "", "client": "De Sport Fabrik BV", "clientCity": "Losser"}, {"nr": "STP22002", "name": "Nieuwbouw Hal Broekhoekweg, Losser", "addr": "Broekhoiekweg 36", "zip": "", "city": "Losser", "exc": 0, "tol": 0, "start": "2022-01-10", "end": "", "client": "GBJ Luttikhuis Holding BV", "clientCity": "Losser"}, {"nr": "STPR18004", "name": "BV Buram, Produktion & Lager Gebaude", "addr": "Heidering 10", "zip": "16727", "city": "Velten", "exc": 0, "tol": 0, "start": "2018-06-27", "end": "", "client": "Buram GmbH", "clientCity": "Hennigsdorf"}, {"nr": "STPR22007", "name": "BV Produktionshalle mit Buro, Witten, DE", "addr": "Feldstrasse 1", "zip": "58456", "city": "Witten", "exc": 0, "tol": 0, "start": "2022-05-25", "end": "", "client": "Ruhrtaler Gesenkschmiede F.W. Wengeler GmbH & Co. KG", "clientCity": "Witten"}, {"nr": "STP22010", "name": "Uitbreiding Bestaande Hal, TNR Vastgoed, Almelo", "addr": "planthofsweg 43", "zip": "7601PH", "city": "Almelo", "exc": 0, "tol": 0, "start": "2022-05-23", "end": "", "client": "TNR Vastgoed BV", "clientCity": "Almelo"}, {"nr": "ST22044", "name": "Controleberekening Zonnepanelen", "addr": "Metaalstraat 22", "zip": "7483PD", "city": "", "exc": 0, "tol": 0, "start": "2022-10-19", "end": "2022-11-23", "client": "Gemini Techniek B.V.", "clientCity": "Haaksbergen"}, {"nr": "STPR19009", "name": "BV Nergiz; 8532m2 Multifunktions Gebaude + 2532m2 Uberdachun", "addr": "Fabriekstrasse 1", "zip": "48455", "city": "Gronau", "exc": 0, "tol": 0, "start": "2019-05-29", "end": "", "client": "Nergiz GmbH & Co. KG", "clientCity": "Gronau"}, {"nr": "STP21015", "name": "Renovatie Bestaand gebouw, de Mars 9, Coevorden", "addr": "De mars 9", "zip": "", "city": "Coevorden", "exc": 0, "tol": 0, "start": "2021-10-12", "end": "2022-12-23", "client": "Wepart BV", "clientCity": "Neede"}, {"nr": "STPR21005", "name": "BV Alfafood, Renovierung, Nurnberg", "addr": "PlatenstraÃŸe 65", "zip": "90441", "city": "NÃ¼rnberg", "exc": 0, "tol": 0, "start": "2021-03-12", "end": "", "client": "Alfafood GmbH", "clientCity": "NÃ¼rnberg"}, {"nr": "STP21003", "name": "Nieuwbouw Overslaghal De Mars, Coevorden", "addr": "De Mars", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2021-03-19", "end": "", "client": "Wepart BV", "clientCity": "Neede"}, {"nr": "STP21005", "name": "Nieuwbouw Hassing Totaalstoffering, Josink-Es", "addr": "Josink-Es", "zip": "", "city": "Enschede", "exc": 0, "tol": 0, "start": "2021-04-08", "end": "", "client": "REHAS BV", "clientCity": "Enschede"}, {"nr": "STP18002", "name": "Beladingsgebouw HCM Moerdijk", "addr": "Vlasweg 11b", "zip": "", "city": "Moerdijk", "exc": 0, "tol": 0, "start": "2018-01-26", "end": "", "client": "Meyland N.V.", "clientCity": "ADEGEM"}, {"nr": "STP17003", "name": "Aufstockung, Gewa Oberhausen", "addr": "Fannhorststrasse 13", "zip": "46117", "city": "Oberhausen", "exc": 0, "tol": 0, "start": "2017-03-03", "end": "", "client": "Plassmeier GmbH", "clientCity": "Oberhausen"}, {"nr": "STP15007", "name": "Pflanzenhalle Voerde", "addr": "HindenburgstraÃŸe", "zip": "46562", "city": "Voerde", "exc": 0, "tol": 0, "start": "2015-12-03", "end": "", "client": "AndrÃ© Lackas", "clientCity": "Wesel"}, {"nr": "STP15008", "name": "Feuerwache, Voerde", "addr": "HindenburgstraÃŸe", "zip": "46562", "city": "Voerde", "exc": 0, "tol": 0, "start": "2015-12-03", "end": "", "client": "AndrÃ© Lackas", "clientCity": "Wesel"}, {"nr": "STP16004", "name": "Neubau Lagerhalle mit integriertes BÃ¼ro", "addr": "Rheinfelser StraÃŸe 116", "zip": "35398", "city": "GieÃŸen", "exc": 0, "tol": 0, "start": "2016-04-08", "end": "", "client": "Natur Food GmbH", "clientCity": "Aschaffenburg"}, {"nr": "STP16005", "name": "Neubau Lagerhalle Nergiz mit verkaufstatte", "addr": "BorgwardstraÃŸe", "zip": "", "city": "Gronau", "exc": 0, "tol": 0, "start": "2016-04-22", "end": "", "client": "Nergiz GmbH & Co. KG", "clientCity": "Gronau"}, {"nr": "STP14003", "name": "V-tron staalconstructie tussenvloer, doorbraak, afbouw", "addr": "Zweedsestraat 6", "zip": "7418 BG", "city": "Deventer", "exc": 0, "tol": 0, "start": "2014-11-13", "end": "2014-12-23", "client": "V-Tron Vastgoed B.V.", "clientCity": "DEVENTER"}, {"nr": "ST17092", "name": "Waterrijk Oesterdam", "addr": "Tholen", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2017-12-07", "end": "2019-07-26", "client": "Sprangers Bouwbedrijf B.V.", "clientCity": "BREDA"}, {"nr": "STP20003", "name": "Nieuwbouw Garage bedrijf Luttikhuis", "addr": "Broekhoekweg 20", "zip": "7582PT", "city": "Losser", "exc": 0, "tol": 0, "start": "2020-03-04", "end": "", "client": "GBJ Luttikhuis Holding BV", "clientCity": "Losser"}, {"nr": "ST21071", "name": "Controle berekening verrijdbare hal Hoebee met zwaardere kra", "addr": "Merwedestraat 56,", "zip": "3313 CS", "city": "Dordrecht", "exc": 0, "tol": 0, "start": "2021-12-08", "end": "", "client": "Scheepswerf Kooiman Hoebee B.V.", "clientCity": "Dordrecht"}, {"nr": "STP16006", "name": "BV Wieland & Jarasch", "addr": "Oberhausen", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2016-08-26", "end": "", "client": "Plassmeier GmbH", "clientCity": "Oberhausen"}, {"nr": "STPR21001", "name": "BV EFEOGLU ET, Neubau einer betreibsstaette, Koln", "addr": "Garzweilerweg/Schleyerhofweg", "zip": "50829", "city": "Koln", "exc": 0, "tol": 0, "start": "2021-01-11", "end": "", "client": "Suedlaendische Feinkost GmbH", "clientCity": "KÃ¶ln"}, {"nr": "STPR21003", "name": "BV BSG Denkmalschutz Gebaude, Hotel, Wohnungen, Nergiz", "addr": "Industriestrasse 11", "zip": "48455", "city": "Gronau", "exc": 0, "tol": 0, "start": "2021-02-15", "end": "", "client": "Nergiz Projektentwicklung GmbH", "clientCity": "GRONAU"}, {"nr": "STP22005", "name": "Uitbreiding Garagebedrijf A&J, Huizen", "addr": "Nijvrheidsweg 26", "zip": "", "city": "Huizen", "exc": 0, "tol": 0, "start": "2022-02-14", "end": "", "client": "Smelt Holding B.V", "clientCity": "Amsterdam"}, {"nr": "STPR21022", "name": "BV Neubau Logistik Zentrum Gronau, Monari", "addr": "Borgsigstrasse 14", "zip": "48599", "city": "Gronau", "exc": 0, "tol": 0, "start": "2021-12-20", "end": "", "client": "Monari Immobilien GmbH", "clientCity": "Gronau"}, {"nr": "STPR19001", "name": "Omar Erweiterung Lager Halle, 15 x 5 meter", "addr": "Schurblick 5A", "zip": "", "city": "Gronau", "exc": 0, "tol": 0, "start": "2019-01-03", "end": "", "client": "Nourzia Omar-Nasrat", "clientCity": "Gronau"}, {"nr": "STPR19012", "name": "BV Af-Pack, Neubau einer Lagerhalle 2.300m2", "addr": "BornstraÃŸe 273", "zip": "44145", "city": "Dortmund", "exc": 0, "tol": 0, "start": "2019-06-28", "end": "", "client": "KO-DI Grundstuecksgemeinschaft GbR", "clientCity": "Dortmund"}, {"nr": "STPR18001", "name": "Kuch BV Gewerbe Halle Orsoy, Meldeweg", "addr": "Meldeweg 5", "zip": "47495", "city": "Rheinberg", "exc": 0, "tol": 0, "start": "2018-03-06", "end": "", "client": "Ute Kuch", "clientCity": "Rheinberg"}, {"nr": "STPR19013", "name": "Lieferung Stahlkonstruktion + Dach Anbau Wohung Philippe Sch", "addr": "Losserstrasse 109", "zip": "", "city": "Gronau", "exc": 0, "tol": 0, "start": "2019-07-22", "end": "", "client": "Philippe Schol", "clientCity": "Gronau"}, {"nr": "STP22003", "name": "Vervangen Overheaddeur", "addr": "Avelingen West 10", "zip": "4202 MS", "city": "Gorinchem", "exc": 0, "tol": 0, "start": "2022-01-17", "end": "", "client": "Stigterstaal B.V.", "clientCity": "GORINCHEM"}, {"nr": "STPR17007", "name": "Barkhofen Eventausstattung Ãœberdachung 32*12mtr Dinslaken", "addr": "DieselstraÃŸe 13", "zip": "46539", "city": "Dinslaken", "exc": 0, "tol": 0, "start": "2017-10-12", "end": "", "client": "Barkhofen BÃ¼ro & BetriebsgelÃ¤nde", "clientCity": "Dinslaken"}, {"nr": "STP18003", "name": "Fortior Fase 1; Stanora Logistieke Hal + Dockhouses", "addr": "De Reulver", "zip": "7544 RT", "city": "Enschede", "exc": 0, "tol": 0, "start": "2018-03-16", "end": "", "client": "Fortior Real Estate BV", "clientCity": "Enschede"}, {"nr": "STP21002", "name": "Kooiman; Verbouwen best loodsen", "addr": "Lindtsedijk 84", "zip": "3336LE", "city": "Zwijndrecht", "exc": 0, "tol": 0, "start": "2021-02-03", "end": "", "client": "Scheepswerf Gebroeders Kooiman B.V.", "clientCity": "Zwijndrecht"}, {"nr": "STPR21006", "name": "BV Alfafood; Neue Wand", "addr": "Draisstrasse 2B", "zip": "91522", "city": "Ansbach", "exc": 0, "tol": 0, "start": "2021-04-07", "end": "", "client": "Alfafood GmbH", "clientCity": "NÃ¼rnberg"}, {"nr": "STP21013", "name": "double number cancelled", "addr": "Buurserstraat 212", "zip": "7544 RG", "city": "Enschede", "exc": 0, "tol": 0, "start": "2021-10-05", "end": "", "client": "Staalmeesters Projects BV", "clientCity": "Losser"}, {"nr": "STP19007", "name": "Nieuwbouw PATboard BV, Josink Es, Enschede", "addr": "Josink Es", "zip": "", "city": "Enschede", "exc": 0, "tol": 0, "start": "2019-06-19", "end": "", "client": "PATzest B.V.", "clientCity": "Enschede"}, {"nr": "STP19004", "name": "Meyland; STC Eurochem", "addr": "Eurochem", "zip": "", "city": "Antwerpen", "exc": 0, "tol": 0, "start": "2019-03-13", "end": "", "client": "Meyland N.V.", "clientCity": "ADEGEM"}, {"nr": "STPR20004", "name": "BV Eurofrucht, 2700m2 Lagerhalle + Buro, Hettstedt", "addr": "Ritterroeder Strasse", "zip": "", "city": "Hettstedt", "exc": 0, "tol": 0, "start": "2020-09-21", "end": "", "client": "Eurofrucht", "clientCity": "Hettstedt"}, {"nr": "STP19008", "name": "Crown Food XL; Opslag hal met inpandig kantoor", "addr": "Osseboer", "zip": "", "city": "Enschede", "exc": 0, "tol": 0, "start": "2019-09-13", "end": "", "client": "Jeruzalem Onroerend Goed B.V.", "clientCity": "Enschede"}, {"nr": "ST18065", "name": "Nieuwbouw Twentseplaten specialist BV", "addr": "Twentepoort", "zip": "", "city": "Almelo", "exc": 0, "tol": 0, "start": "2018-12-17", "end": "", "client": "Olde Hensken Vastgoed B.V.", "clientCity": "Almelo"}, {"nr": "STP19005", "name": "Nieuwbouw Impexstaal", "addr": "Avelingen-West 2-6", "zip": "", "city": "Gorinchem", "exc": 0, "tol": 0, "start": "2019-03-26", "end": "", "client": "Impexstaal Holding BV", "clientCity": "Gorinchem"}, {"nr": "STPR19018", "name": "BV NeickenPartner, Erweiterung der betriebsstÃ¤tte", "addr": "weissensteinstr. 90b", "zip": "46149", "city": "Oberhausen", "exc": 0, "tol": 0, "start": "2019-09-02", "end": "", "client": "Neickenpartner Licht- und Werbetechnik GmbH", "clientCity": "OBERHAUSEN"}, {"nr": "STPR19007", "name": "Neubau Trinity Immobilien BV", "addr": "Brusselerstrasse", "zip": "48455", "city": "Gilde hausen", "exc": 0, "tol": 0, "start": "2019-03-13", "end": "", "client": "Trinity Immobilien B.V.", "clientCity": "Oldenzaal"}, {"nr": "STP20005", "name": "Coeck Cladding del&erect, STC erect", "addr": "Coeck De Laetstraat 6", "zip": "2845", "city": "Niel", "exc": 0, "tol": 0, "start": "2020-05-29", "end": "", "client": "Meyland N.V.", "clientCity": "ADEGEM"}, {"nr": "STP20004", "name": "Cross-Fit Kooi", "addr": "Smitsbreeweg 8,", "zip": "7581HE", "city": "Losser", "exc": 0, "tol": 0, "start": "2020-05-14", "end": "", "client": "EBS Holding BV", "clientCity": "Enschede"}, {"nr": "STP19010", "name": "Fortior Fase 3; De Reulver 53-55", "addr": "De reulver 53-55", "zip": "", "city": "Enschede", "exc": 0, "tol": 0, "start": "2019-09-30", "end": "", "client": "Fortior Real Estate BV", "clientCity": "Enschede"}, {"nr": "STP17001", "name": "Projekt Nergiz FabrikstraÃŸe 11, Gronau", "addr": "Gronau", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2017-01-24", "end": "2017-08-22", "client": "Nergiz GmbH & Co. KG", "clientCity": "Gronau"}, {"nr": "STP15001", "name": "Erweiterung Sultan Halle und Buro", "addr": "Koln", "zip": "", "city": "Koln", "exc": 0, "tol": 0, "start": "2015-05-07", "end": "", "client": "Oktay Uludogan", "clientCity": "BERGISCH GLADBACH"}, {"nr": "ST18048", "name": "Controle berekening brug Mouterij albert", "addr": "Antwerpen", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2018-09-12", "end": "", "client": "Meyland N.V.", "clientCity": "ADEGEM"}, {"nr": "STP18008", "name": "Serre 17x7x3m aan bestaand pand", "addr": "Haaksbergerstraat 166-1", "zip": "7554PB", "city": "Hengelo", "exc": 0, "tol": 0, "start": "2018-11-28", "end": "", "client": "Holland Middle East Trading BV", "clientCity": "ENSCHEDE"}, {"nr": "ST17084", "name": "18 no. THQ Steel beams, Ambu, Ballerup, Denmark", "addr": "Ambu A/S Baltorpparken 13", "zip": "2750", "city": "Ballerup", "exc": 0, "tol": 0, "start": "2017-10-24", "end": "", "client": "Stal & Design A/S", "clientCity": "NÃ¦stved"}, {"nr": "STPR17002", "name": "Uitbouw Hotel Schurblick 9, Gronau", "addr": "SchÃ¼rblick 9", "zip": "48599", "city": "Gronau", "exc": 0, "tol": 0, "start": "2017-07-03", "end": "", "client": "Nergiz GmbH & Co. KG", "clientCity": "Gronau"}, {"nr": "STP16008", "name": "Entwurf Pisulla", "addr": "Kirchhellener StraÃŸe", "zip": "46145", "city": "Oberhausen", "exc": 0, "tol": 0, "start": "2016-12-21", "end": "", "client": "Plassmeier GmbH", "clientCity": "Oberhausen"}, {"nr": "ST17004", "name": "Verlenging Slipway Damex", "addr": "Santiago de Cuba", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2017-01-16", "end": "", "client": "Damen Shipyards Gorinchem B.V.", "clientCity": "GORINCHEM"}, {"nr": "ST15147", "name": "BV2222 Bayreuth", "addr": "Am Bauhof 5", "zip": "D-95445", "city": "Bayreuth", "exc": 0, "tol": 0, "start": "2015-12-02", "end": "", "client": "PEM GmbH Landshut (Deutschland)", "clientCity": "Landshut"}, {"nr": "STP15002", "name": "Erweiterung Autowerkstatt Mercedes Becker", "addr": "Max-Eyth-Strass 1", "zip": "46149", "city": "Oberhausen", "exc": 0, "tol": 0, "start": "2015-05-07", "end": "", "client": "BeckergrundstÃ¼cksverwaltung GmbH & Co KG", "clientCity": "Oberhausen"}, {"nr": "STP14001", "name": "Neubau Yamaha", "addr": "Duisburger StraBe 100", "zip": "", "city": "Oberhausen", "exc": 0, "tol": 0, "start": "2014-09-22", "end": "", "client": "Plassmeier GmbH", "clientCity": "Oberhausen"}, {"nr": "ST14045", "name": "Fa. Hilti", "addr": "Oberhausen", "zip": "", "city": "Oberhausen", "exc": 0, "tol": 0, "start": "2014-04-04", "end": "", "client": "Plassmeier GmbH", "clientCity": "Oberhausen"}, {"nr": "ST16062", "name": "LBK frames", "addr": "VAF instruments", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2016-05-18", "end": "", "client": "Van Dorp installaties B.V.", "clientCity": "Zoetermeer"}, {"nr": "ST16091", "name": "Purlin Supports HDG", "addr": "Moerdijk", "zip": "", "city": "", "exc": 0, "tol": 0, "start": "2016-07-06", "end": "", "client": "Hafkon International BV", "clientCity": "Nieuwkuijk"}, {"nr": "ST15133", "name": "Ondersteunings constructie wheel Pier Scheveningen", "addr": "Strandweg", "zip": "", "city": "Scheveningen", "exc": 0, "tol": 0, "start": "2015-11-04", "end": "", "client": "Bakels en Ouwerkerk Bouw", "clientCity": "'s-GRAVENHAGE"}, {"nr": "STP15006", "name": "Neubau einen Lagerhalle Ute Kuch", "addr": "RheinbergstraÃŸe 192a", "zip": "47495", "city": "Rheinberg", "exc": 0, "tol": 0, "start": "2015-08-07", "end": "", "client": "Plassmeier GmbH", "clientCity": "Oberhausen"}, {"nr": "STP15003", "name": "Bv Minnebusch", "addr": "Oberhausen", "zip": "", "city": "Oberhausen", "exc": 0, "tol": 0, "start": "2015-06-29", "end": "", "client": "Plassmeier GmbH", "clientCity": "Oberhausen"}, {"nr": "ST15145", "name": "71357 Bundle frame & Steelconstruction", "addr": "Nijkerk", "zip": "", "city": "Nijkerk", "exc": 0, "tol": 0, "start": "2015-11-23", "end": "", "client": "Bronswerk Heat Transfer B.V.", "clientCity": "NIJKERK"}, {"nr": "ST15051", "name": "Staalconstructies van project WPB Lith", "addr": "Lith", "zip": "", "city": "Lith", "exc": 0, "tol": 0, "start": "2015-10-01", "end": "", "client": "RWB Water Services BV", "clientCity": "Almelo"}, {"nr": "ST14119", "name": "BV2053 Steelconstruction Bamberg", "addr": "Bamberg", "zip": "D-96047", "city": "Bamberg", "exc": 0, "tol": 0, "start": "2014-10-15", "end": "2014-11-18", "client": "PEM GmbH Landshut (Deutschland)", "clientCity": "Landshut"}, {"nr": "ST13124", "name": "Silo onderbouw Kastenmueller", "addr": "Hafenstr 6", "zip": "48480", "city": "Spelle/Duitsland", "exc": 0, "tol": 0, "start": "2013-06-25", "end": "2013-08-12", "client": "Top-Siloconstructions B.V.", "clientCity": "AALTEN"}, {"nr": "ST15003", "name": "Door Shipyard Cuba", "addr": "Cuba", "zip": "", "city": "Santiago de Cuba", "exc": 0, "tol": 0, "start": "2015-01-06", "end": "", "client": "Damen Shipyards Gorinchem B.V.", "clientCity": "GORINCHEM"}, {"nr": "ST15028", "name": "71318 Bundleframe", "addr": "Nijkerk", "zip": "", "city": "Nijkerk", "exc": 0, "tol": 0, "start": "2015-02-23", "end": "", "client": "Bronswerk Heat Transfer B.V.", "clientCity": "NIJKERK"}, {"nr": "ST15048", "name": "1936-THQ liggers Kinepolis", "addr": "Dordrecht", "zip": "", "city": "Dordrecht", "exc": 0, "tol": 0, "start": "2015-03-31", "end": "", "client": "Oostingh Staalbouw", "clientCity": "KATWIJK"}, {"nr": "ST15057", "name": "Schuifdeuren achterzijde hal 4", "addr": "Moerdijk", "zip": "", "city": "Moerdijk", "exc": 0, "tol": 0, "start": "2015-04-28", "end": "", "client": "Bruinsma Vastgoed B.V.", "clientCity": "MOERDIJK"}, {"nr": "ST15091", "name": "Square Amsterdam", "addr": "Amsterdam", "zip": "", "city": "Amsterdam", "exc": 0, "tol": 0, "start": "2015-07-15", "end": "", "client": "Metaalsluis B.V.", "clientCity": "GENEMUIDEN"}];
const BTYPES={"110": "01.00 Bank", "1623": "02.00 Kantoorartikelen & printer", "3189": "03.00 Vergunningen", "3190": "04.00 Technisch ontwikkelen", "3191": "09.00 Projectmanagement", "3192": "05.00 Bouwplaatsvoorzieningen", "1621": "07.00 Transport", "3216": "08.00 Reiniging", "3248": "10.00 Stut- en Sloopwerkzaamheden", "1620": "12.00 Grondwerk", "3246": "15.00 Terreinverharding", "3195": "16.00 Beplanting", "3242": "17.00 Terreininrichting", "3243": "17.51 Timmerwerk", "3224": "20.00 Funderingspalen en Damwanden", "3175": "21.50 Beton in het werk gestort", "3225": "21.51 Beton in het werk gestort, Monolitisch Afgewerkt", "3247": "21.72 Beton Boringen", "3245": "21.82 Ankers en Bevestigingsmiddelen", "3220": "22.00 Heiwerkzaamheden", "3173": "23.00 Prefab betonnen onderdelen", "111": "24.00 Bouwkundige aannemer", "1619": "25.00 Metaalconstructie bedrijf", "3199": "25.31 Montage Metaalskelet", "3181": "27.00 Ankers en bevestigingsmaterialen", "3228": "28.00 Bouwmaterialen", "3178": "30.00 Deuren, ramen & dakluiken", "3200": "31.00 Dak- & Wandbekleding", "3201": "032 Trappen en balustrades", "3179": "033 Dakbedekking", "3202": "035 Natuursteen", "3203": "040 Stucadoor", "3219": "041 Vloerafwerkingen", "3177": "046.00 Schilderwerk", "3204": "047 Binnenopstellingen & decoratie", "3205": "052 Water installatie", "3206": "054 Brandbeveiliging", "3207": "060 Verwarmings- & ventilatie installatie", "3208": "062 Koelinstallaties", "3174": "070 Elektrische installaties", "3217": "075 Alarm installatie", "3209": "080 Trap & Lift installaties", "3221": "085 Binnen installaties", "1957": "090 Andere", "3180": "095 Accountants", "3218": "096 Auto"};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let PG08 = null;       // pg08.json data
let SUPPLIERS = [];     // suppliers.json data
let templateData = null;

// App state
const S = {
  lang: 'nl',
  project: null,     // selected project object
  supplier: null,    // selected supplier object
  sel: new Set(),    // selected block IDs
  vals: {},          // {blockId: {varId: value}}
  supVars: {},       // {blockId: {varId: true}} â€” supplier-to-specify per var
  delBlocks: new Set(), // delegated entire blocks
  activeBlock: null, // currently open block in editor
};

// Project vars that auto-fill from Construsteel
const PROJECT_VAR_MAP = {
  projectNumber: 'nr', projectName: 'name',
  siteAddress: 'addr', siteZipcode: 'zip', siteCity: 'city',
  clientName: 'client', assemblyStartDate: 'start',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  i18n
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANGS = [
  {code:'nl',flag:'ğŸ‡³ğŸ‡±',label:'NL'},
  {code:'en',flag:'ğŸ‡¬ğŸ‡§',label:'EN'},
  {code:'de',flag:'ğŸ‡©ğŸ‡ª',label:'DE'},
  {code:'sk',flag:'ğŸ‡¸ğŸ‡°',label:'SK'},
  {code:'fa',flag:'ğŸ‡®ğŸ‡·',label:'FA'},
];
const UI = {
  nl:{projSel:'ğŸ” Project selecteren',suppSel:'ğŸ¢ Leverancier selecteren',scopeLbl:'Scope omschrijving',chapLbl:'Hoofdstukken',selBlock:'Selecteer een tekstblok',selBlockH:'Klik op een blok om variabelen te bewerken.',delBtn:'Geheel door leverancier',supBtn:'Door leverancier',noBlocks:'Selecteer blokken in het linker paneel',expBtn:'â¬‡ Word Export',blocks:'blokken',vars:'variabelen',deleg:'gedelegeerd',projPh:'Zoek op naam of nummer...',suppPh:'Zoek leverancier...', dearSir:'Geachte heer/mevrouw,', regards:'Met vriendelijke groet,'},
  en:{projSel:'ğŸ” Select project',suppSel:'ğŸ¢ Select supplier',scopeLbl:'Scope description',chapLbl:'Chapters',selBlock:'Select a text block',selBlockH:'Click a block in the left panel to edit variables.',delBtn:'Entire block by supplier',supBtn:'By supplier',noBlocks:'Select blocks in the left panel',expBtn:'â¬‡ Word Export',blocks:'blocks',vars:'variables',deleg:'delegated',projPh:'Search by name or number...',suppPh:'Search supplier...', dearSir:'Dear Sir/Madam,', regards:'Kind regards,'},
  de:{projSel:'ğŸ” Projekt auswÃ¤hlen',suppSel:'ğŸ¢ Lieferant auswÃ¤hlen',scopeLbl:'Leistungsbeschreibung',chapLbl:'Kapitel',selBlock:'Textbaustein auswÃ¤hlen',selBlockH:'Klicken Sie auf einen Baustein um Variablen zu bearbeiten.',delBtn:'Gesamter Baustein durch Lieferant',supBtn:'Durch Lieferant',noBlocks:'WÃ¤hlen Sie Bausteine im linken Bereich',expBtn:'â¬‡ Word Export',blocks:'Bausteine',vars:'Variablen',deleg:'delegiert',projPh:'Nach Name oder Nummer suchen...',suppPh:'Lieferant suchen...', dearSir:'Sehr geehrte Damen und Herren,', regards:'Mit freundlichen GrÃ¼ÃŸen,'},
  sk:{projSel:'ğŸ” VybraÅ¥ projekt',suppSel:'ğŸ¢ VybraÅ¥ dodÃ¡vateÄ¾a',scopeLbl:'Popis rozsahu',chapLbl:'Kapitoly',selBlock:'Vyberte textovÃ½ blok',selBlockH:'Kliknite na blok pre Ãºpravu premennÃ½ch.',delBtn:'CelÃ½ blok dodÃ¡vateÄ¾om',supBtn:'DodÃ¡vateÄ¾om',noBlocks:'Vyberte bloky vÄ¾avo',expBtn:'â¬‡ Word Export',blocks:'bloky',vars:'premennÃ©',deleg:'delegovanÃ©',projPh:'HÄ¾adaÅ¥ podÄ¾a nÃ¡zvu...',suppPh:'HÄ¾adaÅ¥ dodÃ¡vateÄ¾a...', dearSir:'VÃ¡Å¾enÃ½ pÃ¡n/pani,', regards:'S pozdravom,'},
  fa:{projSel:'ğŸ” Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡',suppSel:'ğŸ¢ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡',scopeLbl:'Ø´Ø±Ø­ Ù…Ø­Ø¯ÙˆØ¯Ù‡',chapLbl:'ÙØµÙ„â€ŒÙ‡Ø§',selBlock:'ÛŒÚ© Ø¨Ù„ÙˆÚ© Ù…ØªÙ†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',selBlockH:'Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ØªØºÛŒØ±Ù‡Ø§ Ø±ÙˆÛŒ Ø¨Ù„ÙˆÚ© Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.',delBtn:'Ú©Ù„ Ø¨Ù„ÙˆÚ© ØªÙˆØ³Ø· ØªØ§Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡',supBtn:'ØªÙˆØ³Ø· ØªØ§Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡',noBlocks:'Ø¨Ù„ÙˆÚ©â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ù¾Ù†Ù„ Ø³Ù…Øª Ú†Ù¾ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',expBtn:'â¬‡ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ±Ø¯',blocks:'Ø¨Ù„ÙˆÚ©',vars:'Ù…ØªØºÛŒØ±',deleg:'ÙˆØ§Ú¯Ø°Ø§Ø± Ø´Ø¯Ù‡',projPh:'Ø¬Ø³ØªØ¬Ùˆ...', suppPh:'Ø¬Ø³ØªØ¬ÙˆÛŒ ØªØ§Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡...', dearSir:'Ø¨Ø§ Ø§Ø­ØªØ±Ø§Ù…ØŒ', regards:'Ø¨Ø§ ØªØ´Ú©Ø±ØŒ'},
};
const t = k => UI[S.lang]?.[k] || UI.nl?.[k] || k;
const L = o => {
  if (!o) return '';
  if (typeof o === 'string') return o;
  return o[S.lang] || o.nl || o.en || Object.values(o)[0] || '';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tabbar button').forEach(b => b.classList.remove('on'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLangBar() {
  document.getElementById('lang-bar').innerHTML = LANGS.map(l =>
    `<button class="${l.code===S.lang?'on':''}" onclick="setLang('${l.code}')">${l.flag} ${l.label}</button>`
  ).join('');
}
function setLang(code) {
  S.lang = code;
  document.documentElement.lang = code;
  document.documentElement.dir = code==='fa' ? 'rtl' : 'ltr';
  buildLangBar(); applyUI(); renderChapters(); renderVarForm(); renderPreview(); updateStatus();
}
function applyUI() {
  document.getElementById('lbl-proj').textContent = t('projSel');
  document.getElementById('lbl-supp').textContent = t('suppSel');
  document.getElementById('lbl-scope').textContent = t('scopeLbl');
  document.getElementById('lbl-chapters').textContent = t('chapLbl');
  document.getElementById('mid-title').textContent = t('selBlock');
  document.getElementById('mid-desc').textContent = t('selBlockH');
  document.getElementById('btn-export').textContent = t('expBtn');
  document.getElementById('proj-search').placeholder = t('projPh');
  document.getElementById('supp-search').placeholder = t('suppPh');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROJECT SELECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function filterProjects() {
  const q = document.getElementById('proj-search').value.toLowerCase().trim();
  const dd = document.getElementById('proj-dd');
  if (!q) { dd.classList.remove('show'); return; }
  const matches = PROJECTS.filter(p =>
    p.nr.toLowerCase().includes(q) || p.name.toLowerCase().includes(q) || p.city.toLowerCase().includes(q) || p.client.toLowerCase().includes(q)
  ).slice(0, 15);
  dd.innerHTML = matches.map((p, i) =>
    `<div class="dd-item" onclick="selectProject(${i},'${encodeURIComponent(JSON.stringify(p))}')"><div class="main">${esc(p.nr)} â€” ${esc(p.name)}</div><div class="sub">${esc(p.city)} Â· ${esc(p.client)}</div></div>`
  ).join('') || '<div class="dd-item"><div class="sub">Geen resultaten</div></div>';
  dd.classList.add('show');
}
function selectProject(i, encoded) {
  const p = JSON.parse(decodeURIComponent(encoded));
  S.project = p;
  document.getElementById('proj-search').value = '';
  document.getElementById('proj-dd').classList.remove('show');
  document.getElementById('proj-selected').style.display = 'block';
  document.getElementById('proj-selected').innerHTML = `<div class="selected-tag"><span class="name">${esc(p.nr)} â€” ${esc(p.name)}</span><span class="clear" onclick="clearProject()">Ã—</span></div>`;
  // Auto-fill variables
  autoFillProjectVars();
  renderVarForm(); renderPreview(); updateStatus();
}
function clearProject() {
  S.project = null;
  document.getElementById('proj-selected').style.display = 'none';
  // Clear auto-filled project vars
  for (const blockId of Object.keys(S.vals)) {
    for (const [varId, projKey] of Object.entries(PROJECT_VAR_MAP)) {
      if (S.vals[blockId]?.[varId] !== undefined) {
        S.vals[blockId][varId] = '';
      }
    }
  }
  renderVarForm(); renderPreview(); updateStatus();
}
function autoFillProjectVars() {
  if (!S.project || !PG08) return;
  for (const ch of PG08.chapters) {
    for (const bl of ch.blocks) {
      if (!S.vals[bl.id]) S.vals[bl.id] = {};
      for (const v of (bl.variables || [])) {
        const projKey = PROJECT_VAR_MAP[v.id];
        if (projKey && S.project[projKey]) {
          S.vals[bl.id][v.id] = S.project[projKey];
        }
      }
      // Also fill scopeDescription from the scope input
      if (bl.variables?.some(v => v.id === 'scopeDescription')) {
        const sd = document.getElementById('scope-desc').value;
        if (sd) S.vals[bl.id].scopeDescription = sd;
      }
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPPLIER SELECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PG08_BT_ORDER = ['3199','3200','1619','3178','3192','1621'];
function filterSuppliers() {
  const q = document.getElementById('supp-search').value.toLowerCase().trim();
  const dd = document.getElementById('supp-dd');
  if (!q) { dd.classList.remove('show'); return; }
  // Group by business type, prioritize PG08-relevant
  const matches = SUPPLIERS.filter(s =>
    s.name.toLowerCase().includes(q) || s.short.toLowerCase().includes(q) || s.city.toLowerCase().includes(q)
  );
  // Sort: PG08 relevant first, then alphabetical
  matches.sort((a,b) => {
    const ai = PG08_BT_ORDER.indexOf(a.bt);
    const bi = PG08_BT_ORDER.indexOf(b.bt);
    const ap = ai >= 0 ? ai : 99;
    const bp = bi >= 0 ? bi : 99;
    if (ap !== bp) return ap - bp;
    return a.name.localeCompare(b.name);
  });
  const limited = matches.slice(0, 20);
  let html = '';
  let lastBt = '';
  for (const s of limited) {
    if (s.bt !== lastBt) {
      lastBt = s.bt;
      const btLabel = BTYPES[s.bt] || 'Other';
      html += `<div class="dd-cat">${esc(btLabel)}</div>`;
    }
    const contact = [s.fn, s.ln].filter(Boolean).join(' ');
    html += `<div class="dd-item" onclick="selectSupplier('${s.id}','${esc(s.fn)}','${esc(s.ln)}')"><div class="main">${esc(s.name)}</div><div class="sub">${esc(s.city)}${contact ? ' Â· '+esc(contact) : ''}</div></div>`;
  }
  dd.innerHTML = html || '<div class="dd-item"><div class="sub">Geen resultaten</div></div>';
  dd.classList.add('show');
}
function selectSupplier(id, fn, ln) {
  const s = SUPPLIERS.find(x => x.id === id && x.fn === decodeURIComponent(fn) && x.ln === decodeURIComponent(ln))
         || SUPPLIERS.find(x => x.id === id);
  if (!s) return;
  S.supplier = s;
  document.getElementById('supp-search').value = '';
  document.getElementById('supp-dd').classList.remove('show');
  document.getElementById('supp-selected').style.display = 'block';
  const btLabel = BTYPES[s.bt] || '';
  const contact = [s.fn, s.ln].filter(Boolean).join(' ');
  document.getElementById('supp-selected').innerHTML = `<div class="selected-tag"><span class="name">${esc(s.name)}${btLabel ? ' <span style="font-size:9px;color:var(--txtL)">'+esc(btLabel)+'</span>' : ''}${contact ? '<br><span style="font-size:10px;color:var(--txtL)">'+esc(contact)+'</span>' : ''}</span><span class="clear" onclick="clearSupplier()">Ã—</span></div>`;
  renderPreview(); updateStatus();
}
function clearSupplier() {
  S.supplier = null;
  document.getElementById('supp-selected').style.display = 'none';
  renderPreview(); updateStatus();
}

// Close dropdowns on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('#proj-selector')) document.getElementById('proj-dd').classList.remove('show');
  if (!e.target.closest('#supp-selector')) document.getElementById('supp-dd').classList.remove('show');
});
function showDropdown(type) {
  const input = document.getElementById(type + '-search');
  if (input.value.trim()) {
    if (type === 'proj') filterProjects(); else filterSuppliers();
  }
}

function onScopeChange() {
  // Push scope into scopeDescription var in all blocks
  const sd = document.getElementById('scope-desc').value;
  if (!PG08) return;
  for (const ch of PG08.chapters) {
    for (const bl of ch.blocks) {
      if (!S.vals[bl.id]) S.vals[bl.id] = {};
      if (bl.variables?.some(v => v.id === 'scopeDescription')) {
        S.vals[bl.id].scopeDescription = sd;
      }
    }
  }
  renderVarForm(); renderPreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAPTER & BLOCK LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChapters() {
  if (!PG08) return;
  const el = document.getElementById('ch-list');
  let html = '';
  for (const ch of PG08.chapters) {
    const selCount = ch.blocks.filter(b => S.sel.has(b.id)).length;
    const isOpen = ch.blocks.some(b => S.sel.has(b.id)) || ch.blocks.length <= 4;
    html += `<div class="ch-group${isOpen?' open':''}" id="chg-${ch.id}">`;
    html += `<div class="ch-head${isOpen?' open':''}" onclick="toggleChapter('${ch.id}')">`;
    html += `<span class="arrow">â–¶</span>`;
    html += `<span class="num">${ch.number}</span>`;
    html += `<span class="title">${esc(L(ch.title))}</span>`;
    html += `<span class="count">${selCount}/${ch.blocks.length}</span>`;
    html += `</div>`;
    html += `<div class="ch-blocks">`;
    for (const bl of ch.blocks) {
      const isOn = S.sel.has(bl.id);
      const isDel = S.delBlocks.has(bl.id);
      const isActive = S.activeBlock === bl.id;
      html += `<div class="bl-item${isOn?' on':''}${isDel?' delegated':''}${isActive?' active':''}" data-bid="${bl.id}">`;
      html += `<div class="chk" onclick="event.stopPropagation();toggleBlock('${bl.id}')">âœ“</div>`;
      html += `<div class="bl-label" onclick="openBlock('${bl.id}')">${esc(L(bl.label))}</div>`;
      if (isDel) html += `<span class="bl-tag" style="background:var(--blL);color:var(--bl);">â‡„</span>`;
      html += `</div>`;
    }
    html += `</div></div>`;
  }
  el.innerHTML = html;
}

function toggleChapter(chId) {
  const g = document.getElementById('chg-' + chId);
  const h = g.querySelector('.ch-head');
  g.classList.toggle('open');
  h.classList.toggle('open');
}

function toggleBlock(blId) {
  if (S.sel.has(blId)) {
    S.sel.delete(blId);
    S.delBlocks.delete(blId);
    if (S.activeBlock === blId) S.activeBlock = null;
  } else {
    S.sel.add(blId);
  }
  renderChapters(); renderVarForm(); renderPreview(); updateStatus();
}

function openBlock(blId) {
  if (!S.sel.has(blId)) S.sel.add(blId);
  S.activeBlock = blId;
  renderChapters(); renderVarForm(); renderPreview(); updateStatus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VARIABLE FORM (middle panel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBlock(blId) {
  if (!PG08) return null;
  for (const ch of PG08.chapters) {
    const b = ch.blocks.find(x => x.id === blId);
    if (b) return { block: b, chapter: ch };
  }
  return null;
}

function renderVarForm() {
  const container = document.getElementById('var-container');
  const empty = document.getElementById('mid-empty');

  if (!S.activeBlock || !S.sel.has(S.activeBlock)) {
    container.style.display = 'none';
    empty.style.display = 'flex';
    document.getElementById('mid-title').textContent = t('selBlock');
    document.getElementById('mid-desc').textContent = t('selBlockH');
    return;
  }

  empty.style.display = 'none';
  container.style.display = 'block';

  const info = getBlock(S.activeBlock);
  if (!info) return;
  const { block: bl, chapter: ch } = info;

  document.getElementById('mid-title').textContent = `${ch.number}. ${L(ch.title)} â†’ ${L(bl.label)}`;
  document.getElementById('mid-desc').textContent = '';

  if (!S.vals[bl.id]) S.vals[bl.id] = {};
  if (!S.supVars[bl.id]) S.supVars[bl.id] = {};

  const isDel = S.delBlocks.has(bl.id);
  const vars = bl.variables || [];

  let html = '';

  // Block controls
  html += `<div class="block-card">`;
  html += `<div class="block-controls">`;
  html += `<button class="toggle-btn del${isDel?' on':''}" onclick="toggleDelegate('${bl.id}')">${isDel?'âœ“ ':''} ${t('delBtn')}</button>`;
  html += `</div>`;

  if (isDel) {
    html += `<p style="color:var(--bl);font-style:italic;font-size:12px;">Dit volledige blok wordt door de leverancier gespecificeerd.</p>`;
  } else if (vars.length === 0) {
    html += `<p style="color:var(--txtL);font-size:12px;">Dit blok heeft geen variabelen â€” de tekst wordt als vaste tekst opgenomen.</p>`;
  } else {
    html += `<div class="var-grid">`;
    for (const v of vars) {
      const val = S.vals[bl.id]?.[v.id] || '';
      const isSup = S.supVars[bl.id]?.[v.id] || false;
      const isAutoFilled = PROJECT_VAR_MAP[v.id] && S.project && S.project[PROJECT_VAR_MAP[v.id]];
      const cls = isSup ? 'var-field supplier-spec' : isAutoFilled ? 'var-field auto-filled' : 'var-field';
      const ph = L(v.placeholder) || '';

      html += `<div class="${cls}">`;
      html += `<label>${esc(L(v.label))}${v.required ? ' *' : ''}</label>`;

      if (v.type === 'select') {
        html += `<select onchange="setVar('${bl.id}','${v.id}',this.value)"${isSup?' disabled':''}>`;
        html += `<option value="">â€” kies â€”</option>`;
        for (const opt of (v.options || [])) {
          const optVal = typeof opt === 'string' ? opt : opt.value;
          const optLabel = typeof opt === 'string' ? opt : L(opt.label) || opt.value;
          html += `<option value="${esc(optVal)}"${val===optVal?' selected':''}>${esc(optLabel)}</option>`;
        }
        html += `</select>`;
      } else if (v.type === 'multiline') {
        html += `<textarea oninput="setVar('${bl.id}','${v.id}',this.value)"${isSup?' disabled':''}placeholder="${esc(ph)}">${esc(val)}</textarea>`;
      } else if (v.type === 'date') {
        html += `<input type="date" value="${esc(val)}" onchange="setVar('${bl.id}','${v.id}',this.value)"${isSup?' disabled':''}>`;
      } else if (v.type === 'number') {
        html += `<input type="number" value="${esc(val)}" placeholder="${esc(ph)}" oninput="setVar('${bl.id}','${v.id}',this.value)"${isSup?' disabled':''}>`;
      } else {
        html += `<input type="text" value="${esc(val)}" placeholder="${esc(ph)}" oninput="setVar('${bl.id}','${v.id}',this.value)"${isSup?' disabled':''}>`;
      }

      if (v.supplierCanSpecify !== false) {
        html += `<span class="sup-toggle" onclick="toggleSupVar('${bl.id}','${v.id}')">${isSup ? 'âœ“ ' : ''}${t('supBtn')}</span>`;
      }
      html += `</div>`;
    }
    html += `</div>`;
  }
  html += `</div>`;

  // Show block text preview
  html += `<div class="block-card" style="background:#fafbfc;border-style:dashed;">`;
  html += `<h4 style="font-size:11px;color:var(--txtL);margin-bottom:6px;">Tekst preview</h4>`;
  html += `<div style="font-size:11.5px;line-height:1.6;color:var(--dk);">${renderBlockText(bl)}</div>`;
  html += `</div>`;

  container.innerHTML = html;
}

function setVar(blId, varId, val) {
  if (!S.vals[blId]) S.vals[blId] = {};
  S.vals[blId][varId] = val;
  renderPreview(); updateStatus();
  // Also update the text preview in the block card
  const info = getBlock(blId);
  if (info) {
    const preview = document.querySelector('#var-container .block-card:last-child div:last-child');
    if (preview) preview.innerHTML = renderBlockText(info.block);
  }
}

function toggleSupVar(blId, varId) {
  if (!S.supVars[blId]) S.supVars[blId] = {};
  S.supVars[blId][varId] = !S.supVars[blId][varId];
  renderVarForm(); renderPreview(); updateStatus();
}

function toggleDelegate(blId) {
  if (S.delBlocks.has(blId)) S.delBlocks.delete(blId);
  else S.delBlocks.add(blId);
  renderChapters(); renderVarForm(); renderPreview(); updateStatus();
}

function renderBlockText(bl) {
  if (S.delBlocks.has(bl.id)) {
    return `<span style="color:var(--bl);font-style:italic;">[${t('delBtn')}]</span>`;
  }
  let txt = L(bl.text);
  txt = txt.replace(/\{\{(\w+)\}\}/g, (m, varId) => {
    const isSup = S.supVars[bl.id]?.[varId];
    if (isSup) return `<span class="pv-var supplier">[${t('supBtn')}]</span>`;
    const val = S.vals[bl.id]?.[varId];
    if (val) return `<span class="pv-var filled">${esc(val)}</span>`;
    return `<span class="pv-var">${varId}</span>`;
  });
  return txt.replace(/\n/g, '<br>');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPreview() {
  if (!PG08) return;
  const el = document.getElementById('preview');
  const sel = [];
  for (const ch of PG08.chapters) {
    const chBlocks = ch.blocks.filter(b => S.sel.has(b.id));
    if (chBlocks.length) sel.push({ ch, blocks: chBlocks });
  }

  if (!sel.length) {
    el.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“„</div><p>${t('noBlocks')}</p></div>`;
    return;
  }

  let html = '';
  for (const { ch, blocks } of sel) {
    html += `<div class="pv-chapter">${ch.number}. ${esc(L(ch.title))}</div>`;
    for (const bl of blocks) {
      html += `<div class="pv-block-title">${esc(L(bl.label))}</div>`;
      if (S.delBlocks.has(bl.id)) {
        html += `<div class="pv-delegated">[${t('delBtn')}]</div>`;
        continue;
      }
      let txt = L(bl.text);
      txt = txt.replace(/\{\{(\w+)\}\}/g, (m, varId) => {
        const isSup = S.supVars[bl.id]?.[varId];
        if (isSup) return `<span class="pv-var supplier">[${t('supBtn')}]</span>`;
        const val = S.vals[bl.id]?.[varId];
        if (val) return `<span class="pv-var filled">${esc(val)}</span>`;
        return `<span class="pv-var">${varId}</span>`;
      });
      txt.split('\n').forEach(line => {
        const ln = line.trim();
        if (!ln) return;
        const cls = (ln.startsWith('-') || ln.startsWith('â€¢')) ? 'pv-bullet' : 'pv-line';
        html += `<div class="${cls}">${ln}</div>`;
      });
    }
  }
  el.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStatus() {
  if (!PG08) return;
  const selBlocks = S.sel.size;
  let totalVars = 0, filledVars = 0;
  for (const ch of PG08.chapters) {
    for (const bl of ch.blocks) {
      if (!S.sel.has(bl.id)) continue;
      for (const v of (bl.variables || [])) {
        totalVars++;
        if (S.vals[bl.id]?.[v.id]) filledVars++;
      }
    }
  }
  document.getElementById('st-blocks').textContent = `${selBlocks} ${t('blocks')}`;
  document.getElementById('st-vars').textContent = `${filledVars}/${totalVars} ${t('vars')}`;
  document.getElementById('st-del').textContent = `${S.delBlocks.size} ${t('deleg')}`;
}

function resetAll() {
  S.sel.clear(); S.delBlocks.clear(); S.activeBlock = null;
  S.vals = {}; S.supVars = {};
  if (PG08) {
    for (const ch of PG08.chapters) {
      for (const bl of ch.blocks) {
        S.vals[bl.id] = {};
        S.supVars[bl.id] = {};
        if (bl.defaultOn) S.sel.add(bl.id);
      }
    }
  }
  if (S.project) autoFillProjectVars();
  renderChapters(); renderVarForm(); renderPreview(); updateStatus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initResize() {
  const colL = document.getElementById('col-left');
  const colR = document.getElementById('col-right');
  const dragL = document.getElementById('drag-left');
  const dragR = document.getElementById('drag-right');
  let active = null, startX = 0, startW = 0;
  function onDown(e, side) {
    e.preventDefault(); active = side;
    startX = e.clientX;
    startW = side==='left' ? colL.offsetWidth : colR.offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    (side==='left'?dragL:dragR).classList.add('dragging');
  }
  dragL.addEventListener('mousedown', e => onDown(e,'left'));
  dragR.addEventListener('mousedown', e => onDown(e,'right'));
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const dx = e.clientX - startX;
    if (active==='left') colL.style.width = Math.max(260,Math.min(460,startW+dx))+'px';
    else colR.style.width = Math.max(260,Math.min(520,startW-dx))+'px';
  });
  document.addEventListener('mouseup', () => {
    if (active) { document.body.style.cursor=''; document.body.style.userSelect=''; dragL.classList.remove('dragging'); dragR.classList.remove('dragging'); active=null; }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORD EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escXml(s) { return esc(s); }

const STM_INTRO = {
  nl:'STM Group is gespecialiseerd in staalconstructies, gevelbekleding en montage voor de utiliteitsbouw. Met ruim 25 jaar ervaring leveren wij complete oplossingen van engineering tot en met oplevering.\n\nDit document betreft een aanvraag voor offerte (RFQ). Hierin vindt u:\n\u2022  Een omschrijving van de gevraagde werkzaamheden en leveringen\n\u2022  De technische specificaties en standaarden\n\u2022  De uitgangspunten en randvoorwaarden voor uitvoering\n\u2022  De commerciÃ«le voorwaarden\n\nWij verzoeken u uw aanbieding volledig en conform de gestelde eisen in te dienen. Afwijkingen, aannames en uitsluitingen dienen expliciet en schriftelijk te worden vermeld. Werkzaamheden die niet expliciet zijn uitgesloten, worden geacht te zijn inbegrepen.',
  en:'STM Group specialises in steel structures, cladding and erection for commercial construction. With over 25 years of experience, we deliver complete solutions from engineering through to handover.\n\nThis document is a Request for Quotation (RFQ). It contains:\n\u2022  A description of the requested works and deliveries\n\u2022  Technical specifications and standards\n\u2022  Site conditions and constraints\n\u2022  Commercial terms\n\nPlease submit your quotation fully compliant with the stated requirements. Deviations, assumptions and exclusions must be explicitly stated in writing.',
  de:'STM Group ist spezialisiert auf Stahlkonstruktionen, Fassadenverkleidung und Montage. Mit Ã¼ber 25 Jahren Erfahrung liefern wir KomplettlÃ¶sungen von der Planung bis zur Ãœbergabe.\n\nDieses Dokument ist eine Angebotsanfrage (RFQ). Es enthÃ¤lt:\n\u2022  Beschreibung der angeforderten Leistungen\n\u2022  Technische Spezifikationen und Standards\n\u2022  Rahmenbedingungen der Baustelle\n\u2022  KaufmÃ¤nnische Bedingungen',
  sk:'STM Group sa Å¡pecializuje na oceÄ¾ovÃ© konÅ¡trukcie, oplÃ¡Å¡tenie a montÃ¡Å¾.\n\nTento dokument je Å¾iadosÅ¥ o cenovÃº ponuku (RFQ).',
  fa:'Ú¯Ø±ÙˆÙ‡ STM Ù…ØªØ®ØµØµ Ø¯Ø± Ø³Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ ÙÙˆÙ„Ø§Ø¯ÛŒ Ùˆ Ù…ÙˆÙ†ØªØ§Ú˜ Ø§Ø³Øª.\n\nØ§ÛŒÙ† Ø³Ù†Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‚ÛŒÙ…Øª (RFQ) Ø§Ø³Øª.'
};

function buildIntroXml() {
  const intro = L(STM_INTRO);
  let xml = '<w:p><w:pPr><w:spacing w:after="60"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="HK Guise" w:hAnsi="HK Guise"/><w:b/><w:bCs/><w:color w:val="F94816"/><w:sz w:val="22"/></w:rPr><w:t xml:space="preserve">' + escXml(L({nl:'Over dit document',en:'About this document',de:'Ãœber dieses Dokument',sk:'O tomto dokumente',fa:'Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø§ÛŒÙ† Ø³Ù†Ø¯'})) + '</w:t></w:r></w:p>';
  intro.split('\n').forEach(line => {
    if (!line.trim()) { xml += '<w:p><w:pPr><w:spacing w:after="20"/></w:pPr></w:p>'; return; }
    xml += '<w:p><w:pPr><w:spacing w:after="30"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="HK Guise Light" w:hAnsi="HK Guise Light"/><w:color w:val="FFFFFF"/><w:sz w:val="16"/></w:rPr><w:t xml:space="preserve">' + escXml(line) + '</w:t></w:r></w:p>';
  });
  return xml;
}

function resolveText(bl) {
  let txt = L(bl.text);
  return txt.replace(/\{\{(\w+)\}\}/g, (m, varId) => {
    if (S.supVars[bl.id]?.[varId]) return '[' + t('supBtn') + ']';
    return S.vals[bl.id]?.[varId] || '[' + varId + ']';
  });
}

function buildBodyXml() {
  if (!PG08) return '';
  let xml = '';

  // Salutation
  xml += '<w:p><w:pPr><w:spacing w:after="80"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="HK Guise Light" w:hAnsi="HK Guise Light"/><w:sz w:val="20"/></w:rPr><w:t xml:space="preserve">' + escXml(t('dearSir')) + '</w:t></w:r></w:p>';
  xml += '<w:p><w:pPr><w:spacing w:after="100"/></w:pPr></w:p>';

  for (const ch of PG08.chapters) {
    const chBlocks = ch.blocks.filter(b => S.sel.has(b.id));
    if (!chBlocks.length) continue;

    // Chapter heading
    xml += '<w:p><w:pPr><w:spacing w:before="300" w:after="100"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="HK Guise" w:hAnsi="HK Guise"/><w:b/><w:bCs/><w:color w:val="F94816"/><w:sz w:val="26"/><w:szCs w:val="26"/></w:rPr><w:t xml:space="preserve">' + escXml(ch.number + '. ' + L(ch.title)) + '</w:t></w:r></w:p>';

    for (const bl of chBlocks) {
      // Block title
      xml += '<w:p><w:pPr><w:spacing w:before="140" w:after="40"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="HK Guise" w:hAnsi="HK Guise"/><w:b/><w:bCs/><w:color w:val="22293B"/><w:sz w:val="20"/></w:rPr><w:t xml:space="preserve">' + escXml(L(bl.label)) + '</w:t></w:r></w:p>';

      if (S.delBlocks.has(bl.id)) {
        xml += '<w:p><w:pPr><w:spacing w:after="60"/></w:pPr><w:r><w:rPr><w:i/><w:color w:val="4A90D9"/><w:sz w:val="20"/></w:rPr><w:t xml:space="preserve">[' + escXml(t('delBtn')) + ']</w:t></w:r></w:p>';
        continue;
      }

      const resolved = resolveText(bl);
      resolved.split('\n').forEach(line => {
        const ln = line.trim();
        if (!ln) { xml += '<w:p><w:pPr><w:spacing w:after="20"/></w:pPr></w:p>'; return; }
        const indent = (ln.startsWith('-') || ln.startsWith('\u2022')) ? '<w:ind w:left="360"/>' : '';
        xml += '<w:p><w:pPr><w:spacing w:after="30" w:line="276" w:lineRule="auto"/>' + indent + '</w:pPr><w:r><w:rPr><w:rFonts w:ascii="HK Guise Light" w:hAnsi="HK Guise Light"/><w:sz w:val="19"/></w:rPr><w:t xml:space="preserve">' + escXml(ln) + '</w:t></w:r></w:p>';
      });
    }
  }

  // Closing
  xml += '<w:p><w:pPr><w:spacing w:before="200" w:after="60"/></w:pPr></w:p>';
  xml += '<w:p><w:pPr><w:spacing w:after="60"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="HK Guise Light" w:hAnsi="HK Guise Light"/><w:sz w:val="20"/></w:rPr><w:t xml:space="preserve">' + escXml(t('regards')) + '</w:t></w:r></w:p>';
  xml += '<w:p><w:r><w:rPr><w:rFonts w:ascii="HK Guise" w:hAnsi="HK Guise"/><w:b/><w:sz w:val="20"/></w:rPr><w:t>STM Group</w:t></w:r></w:p>';

  return xml;
}

function buildTocXml() {
  if (!PG08) return '';
  let items = [];
  for (const ch of PG08.chapters) {
    if (ch.blocks.some(b => S.sel.has(b.id))) {
      items.push(ch.number + '. ' + L(ch.title));
    }
  }
  return items.map(item =>
    '<w:p><w:pPr><w:spacing w:after="60"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="HK Guise Light" w:hAnsi="HK Guise Light"/><w:sz w:val="20"/></w:rPr><w:t xml:space="preserve">' + escXml(item) + '</w:t></w:r></w:p>'
  ).join('');
}

async function exportToWord() {
  try {
    if (!templateData) {
      const resp = await fetch('template.docx');
      if (!resp.ok) throw new Error('Template not found');
      templateData = await resp.arrayBuffer();
    }

    const pn = S.project?.name || document.getElementById('scope-desc').value || '';
    const pc = S.project?.nr || '';
    const sc = document.getElementById('scope-desc').value || '';
    const rfq = document.getElementById('rfq-num').value || '';
    const pd = document.getElementById('rfq-date').value || '';
    const dl = S.lang==='de'?'de-DE':S.lang==='en'?'en-GB':S.lang==='sk'?'sk-SK':'nl-NL';
    const dateStr = pd ? new Date(pd).toLocaleDateString(dl,{day:'numeric',month:'long',year:'numeric'}) : '';

    const zip = new JSZip();
    await zip.loadAsync(templateData.slice(0));

    let docXml = await zip.file('word/document.xml').async('text');

    // Replace ALL occurrences of placeholders (works inside text boxes too since we're doing raw string replacement)
    const ra = (xml, old, val) => { while(xml.indexOf(old)!==-1) xml=xml.replace(old,val); return xml; };

    docXml = ra(docXml, '{{Project name}}', escXml(pn));
    docXml = ra(docXml, '{{Prjocet code}}+{{scope}}', escXml(pc + (sc ? ' \u2014 ' + sc : '')));

    // Page 2: STM intro
    const introPlaceholder = '{{Who we are and What the supplier will face in this documet}}';
    const introRe = new RegExp('<w:p[^>]*>(?:(?!<\\/w:p>)[\\s\\S])*?' + introPlaceholder.replace(/[{}|[\]\\]/g,'\\$&') + '(?:(?!<\\/w:p>)[\\s\\S])*?<\\/w:p>', 'g');
    docXml = docXml.replace(introRe, buildIntroXml());

    // Date
    docXml = ra(docXml, '19 maart 2025', escXml(dateStr));
    // Clean {{ }} wrappers around date
    docXml = docXml.replace(/>(\{\{)<\/w:t>/g, '><\/w:t>');
    docXml = docXml.replace(/>(\}\})<\/w:t>/g, '><\/w:t>');

    // TOC: Replace SDT content
    const sdtM = docXml.match(/<w:sdtContent>([\s\S]*?)<\/w:sdtContent>/);
    if (sdtM) docXml = docXml.replace(sdtM[0], '<w:sdtContent>' + buildTocXml() + '</w:sdtContent>');

    // Body: Replace {{Text Blocks}}
    const tbRe = /<w:p[^>]*>(?:(?!<\/w:p>)[\s\S])*?\{\{Text Blocks\}\}(?:(?!<\/w:p>)[\s\S])*?<\/w:p>/;
    docXml = docXml.replace(tbRe, buildBodyXml());

    zip.file('word/document.xml', docXml);

    // Header
    const hdrFile = zip.file('word/header1.xml');
    if (hdrFile) {
      let hdrXml = await hdrFile.async('text');
      const hdrContent = '<w:p><w:pPr><w:tabs><w:tab w:val="right" w:pos="9072"/></w:tabs></w:pPr>'
        + '<w:r><w:rPr><w:rFonts w:ascii="HK Guise Light" w:hAnsi="HK Guise Light"/><w:sz w:val="14"/></w:rPr>'
        + '<w:t xml:space="preserve">' + escXml(pc + ': ' + rfq) + '</w:t></w:r>'
        + '<w:r><w:tab/></w:r>'
        + '<w:r><w:rPr><w:rFonts w:ascii="HK Guise Light" w:hAnsi="HK Guise Light"/><w:sz w:val="14"/><w:color w:val="F94816"/></w:rPr>'
        + '<w:t xml:space="preserve">Datum: ' + escXml(dateStr) + '</w:t></w:r></w:p>';
      const hdrM = hdrXml.match(/<w:hdr[^>]*>([\s\S]*)<\/w:hdr>/);
      if (hdrM) hdrXml = hdrXml.replace(hdrM[1], hdrContent);
      zip.file('word/header1.xml', hdrXml);
    }

    const blob = await zip.generateAsync({ type:'blob', mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
    const fn = 'RFQ_' + (pc||'DRAFT') + '_' + (rfq||'0000') + '_' + S.lang.toUpperCase() + '.docx';
    saveAs(blob, fn);
  } catch(err) {
    console.error('Export error:', err);
    alert('Export failed: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  try {
    // Load external JSON files
    const [pg08Resp, suppResp] = await Promise.all([
      fetch('data/pg08.json'),
      fetch('data/suppliers.json'),
    ]);
    PG08 = await pg08Resp.json();
    SUPPLIERS = await suppResp.json();

    console.log(`Loaded: ${PG08.chapters.length} chapters, ${SUPPLIERS.length} suppliers, ${PROJECTS.length} projects`);

    // Set default date and RFQ number
    document.getElementById('rfq-date').value = new Date().toISOString().split('T')[0];
    const y = new Date().getFullYear();
    document.getElementById('rfq-num').value = `RFQ-${y}-${String(Math.floor(Math.random()*9000)+1000)}`;

    // Init state
    for (const ch of PG08.chapters) {
      for (const bl of ch.blocks) {
        S.vals[bl.id] = {};
        S.supVars[bl.id] = {};
        if (bl.defaultOn) S.sel.add(bl.id);
      }
    }

    buildLangBar(); applyUI(); renderChapters(); renderVarForm(); renderPreview(); updateStatus();
    initResize();

    // Preload template
    fetch('template.docx').then(r => r.ok ? r.arrayBuffer() : null).then(d => { templateData = d; });

  } catch(err) {
    console.error('Init error:', err);
    document.getElementById('loading').innerHTML = `<p style="color:var(--o);">Error loading data: ${err.message}</p><p style="color:rgba(255,255,255,.4);margin-top:8px;">Make sure data/pg08.json and data/suppliers.json are available.</p>`;
    return;
  }

  document.getElementById('loading').style.display = 'none';
}

init();
</script>

</body>
</html>
